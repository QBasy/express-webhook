<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å - Webhook Viewer</title>
  <link rel="icon" href="/favicon" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
<!-- Header -->
<header class="bg-white shadow-sm border-b border-gray-200">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 w-12 h-12 rounded-full flex items-center justify-center">
          <span class="text-white text-xl font-bold">WV</span>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-gray-800">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h1>
          <p class="text-sm text-gray-500" id="adminName">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <a href="/" class="text-purple-600 hover:text-purple-800 font-medium">
          üîô –ö –≤–µ–±—Ö—É–∫–∞–º
        </a>
        <button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
          –í—ã–π—Ç–∏
        </button>
      </div>
    </div>
  </div>
</header>

<!-- Alert -->
<div id="alert" class="hidden fixed top-20 right-4 z-50 p-4 rounded-lg shadow-lg max-w-md"></div>

<!-- Main Content -->
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Tabs -->
  <div class="mb-6">
    <div class="border-b border-gray-200">
      <nav class="-mb-px flex space-x-8">
        <button onclick="switchTab('pending')" id="tab-pending" class="tab-btn border-b-2 border-purple-600 text-purple-600 py-4 px-1 font-medium">
          –û–∂–∏–¥–∞—é—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è <span id="pending-count" class="ml-2 bg-purple-100 text-purple-600 px-2 py-1 rounded-full text-xs">0</span>
        </button>
        <button onclick="switchTab('approved')" id="tab-approved" class="tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 font-medium">
          –û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ <span id="approved-count" class="ml-2 bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs">0</span>
        </button>
        <button onclick="switchTab('rejected')" id="tab-rejected" class="tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 font-medium">
          –û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ <span id="rejected-count" class="ml-2 bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs">0</span>
        </button>
      </nav>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading" class="text-center py-12">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
    <p class="mt-4 text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</p>
  </div>

  <!-- Users List -->
  <div id="users-container" class="hidden space-y-4"></div>

  <!-- Empty State -->
  <div id="empty-state" class="hidden text-center py-12">
    <div class="text-6xl mb-4">üì≠</div>
    <p class="text-gray-600 text-lg">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</p>
  </div>
</main>

<script>
  const apiBase = window.location.origin;
  let currentTab = 'pending';
  let allUsers = [];

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –ø—Ä–∞–≤
  const token = localStorage.getItem('jwt_token');
  const user = JSON.parse(localStorage.getItem('user') || '{}');

  if (!token) {
    window.location.href = '/login.html';
  }

  if (user.role !== 'admin') {
    alert('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω! –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.');
    window.location.href = '/';
  }

  document.getElementById('adminName').textContent = user.username;

  // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  loadUsers();

  async function loadUsers() {
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('users-container').classList.add('hidden');
    document.getElementById('empty-state').classList.add('hidden');

    try {
      const res = await fetch(`${apiBase}/admin/users`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (res.status === 401) {
        localStorage.removeItem('jwt_token');
        window.location.href = '/login.html';
        return;
      }

      if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');

      const data = await res.json();
      allUsers = data.users.filter(u => u.username !== 'admin'); // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º admin

      updateCounts();
      renderUsers();

    } catch (error) {
      showAlert(error.message, 'error');
    } finally {
      document.getElementById('loading').classList.add('hidden');
    }
  }

  function updateCounts() {
    document.getElementById('pending-count').textContent =
            allUsers.filter(u => u.status === 'pending').length;
    document.getElementById('approved-count').textContent =
            allUsers.filter(u => u.status === 'approved').length;
    document.getElementById('rejected-count').textContent =
            allUsers.filter(u => u.status === 'rejected').length;
  }

  function switchTab(tab) {
    currentTab = tab;

    // Update tab styles
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('border-purple-600', 'text-purple-600');
      btn.classList.add('border-transparent', 'text-gray-500');
    });

    const activeTab = document.getElementById(`tab-${tab}`);
    activeTab.classList.remove('border-transparent', 'text-gray-500');
    activeTab.classList.add('border-purple-600', 'text-purple-600');

    renderUsers();
  }

  function renderUsers() {
    const container = document.getElementById('users-container');
    const emptyState = document.getElementById('empty-state');

    const filteredUsers = allUsers.filter(u => u.status === currentTab);

    if (filteredUsers.length === 0) {
      container.classList.add('hidden');
      emptyState.classList.remove('hidden');
      return;
    }

    emptyState.classList.add('hidden');
    container.classList.remove('hidden');

    container.innerHTML = filteredUsers.map(user => `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 fade-in">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <h3 class="text-lg font-bold text-gray-800">${user.username}</h3>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusBadge(user.status)}">
                                    ${getStatusText(user.status)}
                                </span>
                                ${user.role === 'admin' ? '<span class="px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded-full">Admin</span>' : ''}
                            </div>

                            <div class="space-y-1 text-sm text-gray-600">
                                <p>üìß Email: <span class="font-medium">${user.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span></p>
                                <p>üìÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: <span class="font-medium">${formatDate(user.createdAt)}</span></p>
                                <p>üïê TTL –≤–µ–±—Ö—É–∫–æ–≤: <span class="font-medium">${user.webhookTTL}—Å (${(user.webhookTTL / 3600).toFixed(1)}—á)</span></p>
                            </div>

                            ${user.reason ? `
                                <div class="mt-3 p-3 bg-gray-50 rounded border border-gray-200">
                                    <p class="text-xs font-semibold text-gray-700 mb-1">–ü—Ä–∏—á–∏–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</p>
                                    <p class="text-sm text-gray-600">${user.reason}</p>
                                </div>
                            ` : ''}
                        </div>

                        <div class="flex flex-col space-y-2 ml-4">
                            ${currentTab === 'pending' ? `
                                <button onclick="approveUser('${user._id}')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-medium">
                                    ‚úì –û–¥–æ–±—Ä–∏—Ç—å
                                </button>
                                <button onclick="rejectUser('${user._id}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm font-medium">
                                    ‚úó –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                </button>
                            ` : ''}

                            ${currentTab === 'approved' ? `
                                <button onclick="updateTTL('${user._id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium">
                                    ‚öôÔ∏è TTL
                                </button>
                                <button onclick="deleteUser('${user._id}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm font-medium">
                                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                </button>
                            ` : ''}

                            ${currentTab === 'rejected' ? `
                                <button onclick="approveUser('${user._id}')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-medium">
                                    ‚úì –û–¥–æ–±—Ä–∏—Ç—å
                                </button>
                                <button onclick="deleteUser('${user._id}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm font-medium">
                                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
  }

  async function approveUser(userId) {
    if (!confirm('–û–¥–æ–±—Ä–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;

    try {
      const res = await fetch(`${apiBase}/admin/users/${userId}/approve`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è');

      showAlert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–¥–æ–±—Ä–µ–Ω!', 'success');
      await loadUsers();
    } catch (error) {
      showAlert(error.message, 'error');
    }
  }

  async function rejectUser(userId) {
    const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):');
    if (reason === null) return; // –û—Ç–º–µ–Ω–µ–Ω–æ

    try {
      const res = await fetch(`${apiBase}/admin/users/${userId}/reject`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ reason })
      });

      if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è');

      showAlert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–µ–Ω', 'success');
      await loadUsers();
    } catch (error) {
      showAlert(error.message, 'error');
    }
  }

  async function deleteUser(userId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) return;

    try {
      const res = await fetch(`${apiBase}/admin/users/${userId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');

      showAlert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω', 'success');
      await loadUsers();
    } catch (error) {
      showAlert(error.message, 'error');
    }
  }

  async function updateTTL(userId) {
    const newTTL = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π TTL (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö):', '43200');
    if (!newTTL) return;

    const ttl = parseInt(newTTL);
    if (isNaN(ttl) || ttl < 60 || ttl > 86400) {
      showAlert('TTL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 60 –¥–æ 86400 —Å–µ–∫—É–Ω–¥', 'error');
      return;
    }

    try {
      const res = await fetch(`${apiBase}/admin/users/${userId}/ttl`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ ttl })
      });

      if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è TTL');

      showAlert('TTL –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
      await loadUsers();
    } catch (error) {
      showAlert(error.message, 'error');
    }
  }

  function logout() {
    localStorage.removeItem('jwt_token');
    localStorage.removeItem('user');
    window.location.href = '/login.html';
  }

  function getStatusBadge(status) {
    const badges = {
      pending: 'bg-yellow-100 text-yellow-800',
      approved: 'bg-green-100 text-green-800',
      rejected: 'bg-red-100 text-red-800'
    };
    return badges[status] || 'bg-gray-100 text-gray-800';
  }

  function getStatusText(status) {
    const texts = {
      pending: '–û–∂–∏–¥–∞–µ—Ç',
      approved: '–û–¥–æ–±—Ä–µ–Ω',
      rejected: '–û—Ç–∫–ª–æ–Ω–µ–Ω'
    };
    return texts[status] || status;
  }

  function formatDate(date) {
    return new Date(date).toLocaleString('ru-RU', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  function showAlert(message, type) {
    const colors = {
      success: 'bg-green-100 text-green-800 border-green-300',
      error: 'bg-red-100 text-red-800 border-red-300',
      warning: 'bg-yellow-100 text-yellow-800 border-yellow-300'
    };

    const alertDiv = document.getElementById('alert');
    alertDiv.className = `p-4 rounded-lg border shadow-lg ${colors[type]} fade-in`;
    alertDiv.textContent = message;
    alertDiv.classList.remove('hidden');

    setTimeout(() => {
      alertDiv.classList.add('hidden');
    }, 5000);
  }
</script>
</body>
</html>
