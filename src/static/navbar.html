<style>
    .navbar-dropdown {
        position: relative;
    }

    .navbar-dropdown-menu {
        position: absolute;
        right: 0;
        top: 100%;
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        min-width: 220px;
        z-index: 50;
        border: 1px solid #e5e7eb;

        opacity: 0;
        visibility: hidden;
        transform: translateY(-5px);
        transition: all 0.2s ease;
        pointer-events: none;
    }

    .navbar-dropdown-menu.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
        pointer-events: auto;
    }

    /* Hover zone - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ */
    .navbar-dropdown::before {
        content: '';
        position: absolute;
        top: 100%;
        right: 0;
        width: 100%;
        height: 10px;
        z-index: 49;
    }

    .navbar-dropdown:hover .navbar-dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
        pointer-events: auto;
    }

    @keyframes pulse-dot {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .pulse-dot {
        animation: pulse-dot 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    .navbar-link {
        transition: all 0.2s ease;
    }
    .navbar-link:hover {
        transform: translateY(-2px);
    }
</style>

<header class="bg-white shadow-md border-b-2 border-green-500">
    <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between">
            <!-- Logo & Title -->
            <a href="/" class="flex items-center gap-4 hover:opacity-90 transition-opacity">
                <!-- GREEN-API Logo -->
                <svg width="50" height="50" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <rect width="100" height="100" rx="12" fill="#3B9702"/>
                    <text x="50" y="70" font-family="Arial, sans-serif" font-size="60" font-weight="bold" fill="white" text-anchor="middle">G</text>
                </svg>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Webhook Viewer</h1>
                    <p class="text-xs text-green-600 font-semibold tracking-wide">GREEN-API QA TEAM</p>
                </div>
            </a>

            <!-- Right Side -->
            <div class="flex items-center gap-6">
                <!-- Navigation Links -->
                <nav class="hidden md:flex items-center gap-6" id="navbar-links">
                    <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ JS -->
                </nav>

                <!-- User Menu / Login Button -->
                <div id="navbar-user-section">
                    <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ JS -->
                </div>
            </div>
        </div>
    </div>
</header>

<script>
    (function() {
        const apiBase = window.location.origin;
        const token = localStorage.getItem('jwt_token');
        const userStr = localStorage.getItem('user');
        const currentPage = window.location.pathname;

        console.log('üîß Navbar loading...', { hasToken: !!token, currentPage });

        let user = null;
        try {
            user = userStr ? JSON.parse(userStr) : null;
        } catch (e) {
            console.error('‚ùå Failed to parse user:', e);
            localStorage.removeItem('user');
        }

        const navbarLinks = document.getElementById('navbar-links');
        const navbarUserSection = document.getElementById('navbar-user-section');

        if (!navbarLinks || !navbarUserSection) {
            console.error('‚ùå Navbar elements not found!');
            return;
        }

        const isPublicPage = ['/login.html', '/login', '/register.html', '/register'].some(
            page => currentPage === page || currentPage.startsWith(page)
        );

        if (token && user) {
            console.log('‚úÖ User logged in:', user.username, user.role);

            const links = [
                {
                    href: '/',
                    icon: 'üè†',
                    text: '–ì–ª–∞–≤–Ω–∞—è',
                    active: currentPage === '/' || currentPage === '/index.html'
                },
                {
                    href: '/tester.html',
                    icon: 'üß™',
                    text: 'API Tester',
                    active: currentPage === '/tester.html'
                },
                {
                    href: '/docs',
                    icon: 'üìñ',
                    text: '–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è',
                    active: currentPage === '/docs'
                }
            ];

            if (user.role === 'admin') {
                links.push({
                    href: '/admin.html',
                    icon: 'üëë',
                    text: '–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å',
                    active: currentPage === '/admin.html'
                });
            }

            navbarLinks.innerHTML = links.map(link => `
                <a href="${link.href}"
                   class="navbar-link flex items-center gap-2 font-medium transition-all
                          ${link.active
                ? 'text-green-600 font-semibold'
                : 'text-gray-700 hover:text-green-600'}">
                    <span>${link.icon}</span>
                    <span>${link.text}</span>
                </a>
            `).join('');

            // ========== USER DROPDOWN ==========
            navbarUserSection.innerHTML = `
                <div class="navbar-dropdown">
                    <button id="dropdown-toggle" class="flex items-center gap-3 px-4 py-2 bg-green-50 hover:bg-green-100 rounded-lg transition-all border border-green-200">
                        <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-white font-bold">
                            ${user.username.charAt(0).toUpperCase()}
                        </div>
                        <div class="text-left hidden lg:block">
                            <div class="text-sm font-semibold text-gray-800">${user.username}</div>
                            <div class="text-xs text-green-600">${user.role === 'admin' ? 'üëë Admin' : 'üë§ User'}</div>
                        </div>
                        <svg class="w-4 h-4 text-gray-600 transition-transform" id="dropdown-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>

                    <div class="navbar-dropdown-menu" id="dropdown-menu">
                        <div class="py-2">
                            <!-- User Info -->
                            <div class="px-4 py-3 border-b border-gray-200">
                                <div class="font-semibold text-gray-900">${user.username}</div>
                                <div class="text-xs text-gray-500">${user.email || '–ù–µ—Ç email'}</div>
                                <div class="text-xs text-green-600 mt-1">${user.role === 'admin' ? 'üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
                            </div>

                            <!-- Navigation Links -->
                            <a href="/" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-green-50 transition-colors">
                                <span>üè†</span>
                                <span>–ì–ª–∞–≤–Ω–∞—è</span>
                            </a>
                            <a href="/tester.html" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-green-50 transition-colors">
                                <span>üß™</span>
                                <span>API Tester</span>
                            </a>
                            <a href="/docs" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-green-50 transition-colors">
                                <span>üìñ</span>
                                <span>–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</span>
                            </a>
                            ${user.role === 'admin' ? `
                                <a href="/admin.html" class="flex items-center gap-3 px-4 py-2 text-sm text-purple-600 hover:bg-purple-50 transition-colors font-medium">
                                    <span>üëë</span>
                                    <span>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</span>
                                </a>
                            ` : ''}

                            <div class="border-t border-gray-200 mt-2 pt-2">
                                <button onclick="navbarLogout()" class="w-full flex items-center gap-3 px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors font-medium">
                                    <span>üö™</span>
                                    <span>–í—ã–π—Ç–∏</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // ========== DROPDOWN FUNCTIONALITY ==========
            const dropdownToggle = document.getElementById('dropdown-toggle');
            const dropdownMenu = document.getElementById('dropdown-menu');
            const dropdownArrow = document.getElementById('dropdown-arrow');
            const dropdown = dropdownToggle.closest('.navbar-dropdown');

            let isOpen = false;

            // –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ
            dropdownToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleDropdown();
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–µ–Ω—é
            document.addEventListener('click', function(e) {
                if (!dropdown.contains(e.target)) {
                    closeDropdown();
                }
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeDropdown();
                }
            });

            function toggleDropdown() {
                isOpen = !isOpen;
                if (isOpen) {
                    openDropdown();
                } else {
                    closeDropdown();
                }
            }

            function openDropdown() {
                isOpen = true;
                dropdownMenu.classList.add('show');
                dropdownArrow.style.transform = 'rotate(180deg)';
            }

            function closeDropdown() {
                isOpen = false;
                dropdownMenu.classList.remove('show');
                dropdownArrow.style.transform = 'rotate(0deg)';
            }

        } else {
            console.log('‚ö†Ô∏è User NOT logged in');

            // ========== –ù–ê–í–ò–ì–ê–¶–ò–Ø –î–õ–Ø –ì–û–°–¢–ï–ô ==========
            if (!isPublicPage) {
                // –ù–∞ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∏–Ω–∏–º—É–º
                navbarLinks.innerHTML = '';
                navbarUserSection.innerHTML = `
                    <a href="/login.html"
                       class="px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-all shadow-sm hover:shadow-md">
                        –í–æ–π—Ç–∏
                    </a>
                `;
            } else {
                // –ù–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
                const links = [
                    {
                        href: '/login.html',
                        text: '–í—Ö–æ–¥',
                        active: currentPage === '/login.html'
                    },
                    {
                        href: '/register.html',
                        text: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
                        active: currentPage === '/register.html'
                    }
                ];

                navbarLinks.innerHTML = links.map(link => `
                    <a href="${link.href}"
                       class="navbar-link font-medium transition-all
                              ${link.active
                    ? 'text-green-600 font-semibold'
                    : 'text-gray-700 hover:text-green-600'}">
                        ${link.text}
                    </a>
                `).join('');

                navbarUserSection.innerHTML = `
                    <a href="/login.html"
                       class="px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-all shadow-sm hover:shadow-md">
                        –í–æ–π—Ç–∏
                    </a>
                `;
            }
        }

        window.navbarLogout = function() {
            console.log('üëã Logging out from navbar...');
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                localStorage.clear();
                window.location.href = '/login.html';
            }
        };

        console.log('‚úÖ Navbar loaded successfully!');
    })();
</script>