<style>
    .navbar-dropdown {
        position: relative;
    }

    .navbar-dropdown-menu {
        position: absolute;
        right: 0;
        top: 100%;
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        min-width: 220px;
        z-index: 50;
        border: 1px solid #e5e7eb;

        opacity: 0;
        visibility: hidden;
        transform: translateY(-5px);
        transition: all 0.2s ease;
        pointer-events: none;
    }

    .navbar-dropdown-menu.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
        pointer-events: auto;
    }

    /* Hover zone - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ */
    .navbar-dropdown::before {
        content: '';
        position: absolute;
        top: 100%;
        right: 0;
        width: 100%;
        height: 10px;
        z-index: 49;
    }

    .navbar-dropdown:hover .navbar-dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
        pointer-events: auto;
    }

    @keyframes pulse-dot {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .pulse-dot {
        animation: pulse-dot 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    .navbar-link {
        transition: all 0.2s ease;
    }
    .navbar-link:hover {
        transform: translateY(-2px);
    }
</style>

<script src="https://unpkg.com/lucide@latest"></script>

<header class="bg-white shadow-md border-b-2 border-green-500">
    <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between">
            <!-- Logo & Title -->
            <a href="/" class="flex items-center gap-4 hover:opacity-90 transition-opacity">
                <!-- GREEN-API Logo -->
                <svg width="50" height="50" viewBox="0 0 611.309 729.74" xmlns="http://www.w3.org/2000/svg">
                    <style>
                        .fil0 {fill:#3B9702}
                        .fil2 {fill:white}
                        .fil1 {fill:#3B9702;fill-rule:nonzero}
                    </style>
                    <g>
                        <path class="fil2" d="M402.825 372.256l-89.412 -0.012 0 -71.543 174.363 0c0.707,3.89 1.238,9.187 1.588,15.901 0.345,6.712 0.616,13.167 0.796,19.345 0.171,6.186 0.259,11.044 0.259,14.572 0,24.034 -4.329,46.018 -12.977,65.975 -8.657,19.976 -20.851,37.192 -36.572,51.688 -15.722,14.471 -34.188,25.698 -55.383,33.648 -21.198,7.952 -44.162,11.919 -68.894,11.919 -29.678,0 -56.438,-4.769 -80.292,-14.304 -23.854,-9.538 -44.433,-22.964 -61.74,-40.283 -17.319,-17.307 -30.562,-37.627 -39.756,-60.948 -9.187,-23.314 -13.776,-48.75 -13.776,-76.312 0,-27.553 4.952,-52.992 14.835,-76.313 9.897,-23.326 23.762,-43.637 41.609,-60.95 17.835,-17.311 39.036,-30.739 63.597,-40.271 24.559,-9.538 51.492,-14.319 80.82,-14.319 20.14,0 39.304,2.653 57.499,7.949 18.197,5.309 34.806,12.551 49.821,21.729 15.011,9.187 27.47,19.615 37.355,31.275l-55.642 58.295c-12.721,-12.011 -26.403,-21.466 -41.069,-28.348 -14.664,-6.895 -31.185,-10.334 -49.547,-10.334 -15.206,0 -29.239,2.732 -42.14,8.208 -12.898,5.477 -24.198,13.249 -33.916,23.321 -9.718,10.065 -17.231,21.908 -22.528,35.508 -5.309,13.605 -7.946,28.36 -7.946,44.25 0,15.901 2.82,30.562 8.474,43.991 5.659,13.425 13.517,25.18 23.582,35.246 10.078,10.065 21.82,17.923 35.246,23.582 13.429,5.656 27.913,8.48 43.463,8.48 10.953,0 21.107,-1.677 30.465,-5.04 9.367,-3.351 17.667,-7.95 24.921,-13.777 7.23,-5.827 12.889,-12.718 16.945,-20.67 3.442,-6.709 5.424,-13.865 5.952,-21.458z"/>
                        <path class="fil1" d="M59.99 0.024c-15.036,0.314 -29.867,6.468 -40.765,16.969 -11.337,10.764 -18.332,26.013 -19.106,41.713 -0.226,6.87 -0.046,13.752 -0.101,20.625 0,195.762 -0.012,391.519 0,587.281 0.223,15.115 5.556,30.016 14.496,42.094 6.904,9.254 16.408,17.024 27.687,19.881 7.163,1.878 14.822,1.396 21.805,-1.012 162.69,-49.794 325.393,-99.569 488.071,-149.387 13.71,-4.33 27.239,-10.108 38.539,-19.229 8.648,-6.973 15.643,-16.352 18.713,-27.192 1.833,-6.117 2.238,-12.551 2.092,-18.915 -0.012,-150.524 0.012,-301.036 -0.012,-451.56 -0.146,-15.417 -6.251,-30.687 -16.777,-41.844 -10.639,-11.459 -25.72,-18.545 -41.237,-19.329 -6.794,-0.226 -13.597,-0.046 -20.39,-0.104 -157.416,0 -314.834,-0.009 -472.25,0.012 -0.259,0 -0.506,0 -0.765,0l0 -0.003zm342.835 372.232l-89.412 -0.012 0 -71.543 174.363 0c0.707,3.89 1.238,9.187 1.585,15.901 0.351,6.712 0.619,13.17 0.799,19.345 0.168,6.183 0.259,11.041 0.259,14.572 0,24.03 -4.329,46.018 -12.977,65.978 -8.66,19.973 -20.851,37.189 -36.572,51.685 -15.722,14.474 -34.188,25.695 -55.386,33.648 -21.195,7.949 -44.162,11.919 -68.891,11.919 -29.678,0 -56.441,-4.766 -80.292,-14.304 -23.854,-9.535 -44.433,-22.964 -61.74,-40.283 -17.319,-17.307 -30.565,-37.627 -39.752,-60.951 -9.188,-23.311 -13.777,-48.747 -13.777,-76.312 0,-27.55 4.946,-52.989 14.832,-76.313 9.897,-23.323 23.762,-43.631 41.609,-60.95 17.835,-17.308 39.036,-30.733 63.594,-40.271 24.562,-9.535 51.495,-14.316 80.823,-14.316 20.143,0 39.304,2.656 57.502,7.952 18.194,5.306 34.803,12.551 49.818,21.726 15.011,9.187 27.473,19.612 37.355,31.275l-55.642 58.298c-12.721,-12.011 -26.406,-21.469 -41.069,-28.351 -14.664,-6.895 -31.185,-10.334 -49.55,-10.334 -15.203,0 -29.239,2.732 -42.137,8.208 -12.898,5.477 -24.202,13.249 -33.916,23.324 -9.718,10.065 -17.228,21.905 -22.525,35.502 -5.308,13.608 -7.952,28.36 -7.952,44.253 0,15.901 2.823,30.565 8.48,43.991 5.656,13.428 13.517,25.18 23.582,35.246 10.075,10.062 21.814,17.923 35.243,23.582 13.429,5.656 27.913,8.477 43.463,8.477 10.953,0 21.11,-1.674 30.465,-5.037 9.367,-3.351 17.667,-7.953 24.921,-13.777 7.23,-5.824 12.886,-12.718 16.948,-20.667 3.439,-6.715 5.418,-13.868 5.949,-21.457l0 -0.004z"/>
                    </g>
                </svg>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Webhook Viewer</h1>
                    <p class="text-xs text-green-600 font-semibold tracking-wide">GREEN-API QA TEAM</p>
                </div>
            </a>

            <!-- Right Side -->
            <div class="flex items-center gap-6">
                <!-- Navigation Links -->
                <nav class="hidden md:flex items-center gap-6" id="navbar-links">
                    <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ JS -->
                </nav>

                <!-- User Menu / Login Button -->
                <div id="navbar-user-section">
                    <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ JS -->
                </div>
            </div>
        </div>
    </div>
</header>

<script>
    (function() {
        const apiBase = window.location.origin;
        const token = localStorage.getItem('jwt_token');
        const userStr = localStorage.getItem('user');
        const currentPage = window.location.pathname;

        console.log('üîß Navbar loading...', { hasToken: !!token, currentPage });

        let user = null;
        try {
            user = userStr ? JSON.parse(userStr) : null;
        } catch (e) {
            console.error('‚ùå Failed to parse user:', e);
            localStorage.removeItem('user');
        }

        const navbarLinks = document.getElementById('navbar-links');
        const navbarUserSection = document.getElementById('navbar-user-section');

        if (!navbarLinks || !navbarUserSection) {
            console.error('‚ùå Navbar elements not found!');
            return;
        }

        const isPublicPage = ['/login.html', '/login', '/register.html', '/register'].some(
            page => currentPage === page || currentPage.startsWith(page)
        );

        // Initialize Lucide Icons
        function initNavbarIcons() {
            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 100);
        }

        if (token && user) {
            console.log('‚úÖ User logged in:', user.username, user.role);

            const links = [
                {
                    href: '/',
                    icon: 'home',
                    text: '–ì–ª–∞–≤–Ω–∞—è',
                    active: currentPage === '/' || currentPage === '/index.html'
                },
                {
                    href: '/tester.html',
                    icon: 'flask-conical',
                    text: 'API Tester',
                    active: currentPage === '/tester.html'
                },
                {
                    href: '/json-compare.html',
                    icon: 'scale',
                    text: 'JSON Compare',
                    active: currentPage === '/json-compare.html'
                },
                {
                    href: '/docs',
                    icon: 'book-open',
                    text: '–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è',
                    active: currentPage === '/docs'
                }
            ];

            if (user.role === 'admin') {
                links.push({
                    href: '/admin.html',
                    icon: 'crown',
                    text: '–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å',
                    active: currentPage === '/admin.html'
                });
            }

            navbarLinks.innerHTML = links.map(link => `
                <a href="${link.href}"
                   class="navbar-link flex items-center gap-2 font-medium transition-all
                          ${link.active
                ? 'text-green-600 font-semibold'
                : 'text-gray-700 hover:text-green-600'}">
                    <i data-lucide="${link.icon}" class="w-4 h-4"></i>
                    <span>${link.text}</span>
                </a>
            `).join('');

            // ========== USER DROPDOWN ==========
            navbarUserSection.innerHTML = `
                <div class="navbar-dropdown">
                    <button id="dropdown-toggle" class="flex items-center gap-3 px-4 py-2 bg-green-50 hover:bg-green-100 rounded-lg transition-all border border-green-200">
                        <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-white font-bold">
                            ${user.username.charAt(0).toUpperCase()}
                        </div>
                        <div class="text-left hidden lg:block">
                            <div class="text-sm font-semibold text-gray-800">${user.username}</div>
                            <div class="text-xs text-green-600 flex items-center gap-1">
                                ${user.role === 'admin' ? '<i data-lucide="crown" class="w-3 h-3"></i> Admin' : '<i data-lucide="user" class="w-3 h-3"></i> User'}
                            </div>
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-600 transition-transform" id="dropdown-arrow"></i>
                    </button>

                    <div class="navbar-dropdown-menu" id="dropdown-menu">
                        <div class="py-2">
                            <!-- User Info -->
                            <div class="px-4 py-3 border-b border-gray-200">
                                <div class="font-semibold text-gray-900">${user.username}</div>
                                <div class="text-xs text-gray-500 flex items-center gap-1 mt-1">
                                    <i data-lucide="mail" class="w-3 h-3"></i>
                                    <span>${user.email || '–ù–µ—Ç email'}</span>
                                </div>
                                <div class="text-xs text-green-600 mt-1 flex items-center gap-1">
                                    ${user.role === 'admin'
                ? '<i data-lucide="crown" class="w-3 h-3"></i> –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'
                : '<i data-lucide="user" class="w-3 h-3"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}
                                </div>
                            </div>

                            <!-- Navigation Links -->
                            <a href="/" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-green-50 transition-colors">
                                <i data-lucide="home" class="w-4 h-4"></i>
                                <span>–ì–ª–∞–≤–Ω–∞—è</span>
                            </a>
                            <a href="/tester.html" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-green-50 transition-colors">
                                <i data-lucide="flask-conical" class="w-4 h-4"></i>
                                <span>API Tester</span>
                            </a>
                             <a href="/json-compare.html" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-green-50 transition-colors">
                                <i data-lucide="scale" class="w-4 h-4"></i>
                                <span>JSON Compare</span>
                            </a>
                            <a href="/docs" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-green-50 transition-colors">
                                <i data-lucide="book-open" class="w-4 h-4"></i>
                                <span>–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</span>
                            </a>
                            ${user.role === 'admin' ? `
                                <a href="/admin.html" class="flex items-center gap-3 px-4 py-2 text-sm text-purple-600 hover:bg-purple-50 transition-colors font-medium">
                                    <i data-lucide="crown" class="w-4 h-4"></i>
                                    <span>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</span>
                                </a>
                            ` : ''}

                            <div class="border-t border-gray-200 mt-2 pt-2">
                                <button onclick="navbarLogout()" class="w-full flex items-center gap-3 px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors font-medium">
                                    <i data-lucide="log-out" class="w-4 h-4"></i>
                                    <span>–í—ã–π—Ç–∏</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // ========== DROPDOWN FUNCTIONALITY ==========
            const dropdownToggle = document.getElementById('dropdown-toggle');
            const dropdownMenu = document.getElementById('dropdown-menu');
            const dropdownArrow = document.getElementById('dropdown-arrow');
            const dropdown = dropdownToggle.closest('.navbar-dropdown');

            let isOpen = false;

            // –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ
            dropdownToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleDropdown();
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–µ–Ω—é
            document.addEventListener('click', function(e) {
                if (!dropdown.contains(e.target)) {
                    closeDropdown();
                }
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeDropdown();
                }
            });

            function toggleDropdown() {
                isOpen = !isOpen;
                if (isOpen) {
                    openDropdown();
                } else {
                    closeDropdown();
                }
            }

            function openDropdown() {
                isOpen = true;
                dropdownMenu.classList.add('show');
                dropdownArrow.style.transform = 'rotate(180deg)';
            }

            function closeDropdown() {
                isOpen = false;
                dropdownMenu.classList.remove('show');
                dropdownArrow.style.transform = 'rotate(0deg)';
            }

        } else {
            console.log('‚ö†Ô∏è User NOT logged in');

            // ========== –ù–ê–í–ò–ì–ê–¶–ò–Ø –î–õ–Ø –ì–û–°–¢–ï–ô ==========
            if (!isPublicPage) {
                // –ù–∞ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∏–Ω–∏–º—É–º
                navbarLinks.innerHTML = '';
                navbarUserSection.innerHTML = `
                    <a href="/login.html"
                       class="px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-all shadow-sm hover:shadow-md flex items-center gap-2">
                        <i data-lucide="log-in" class="w-4 h-4"></i>
                        <span>–í–æ–π—Ç–∏</span>
                    </a>
                `;
            } else {
                // –ù–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
                const links = [
                    {
                        href: '/login.html',
                        icon: 'log-in',
                        text: '–í—Ö–æ–¥',
                        active: currentPage === '/login.html'
                    },
                    {
                        href: '/register.html',
                        icon: 'user-plus',
                        text: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
                        active: currentPage === '/register.html'
                    }
                ];

                navbarLinks.innerHTML = links.map(link => `
                    <a href="${link.href}"
                       class="navbar-link font-medium transition-all flex items-center gap-2
                              ${link.active
                    ? 'text-green-600 font-semibold'
                    : 'text-gray-700 hover:text-green-600'}">
                        <i data-lucide="${link.icon}" class="w-4 h-4"></i>
                        <span>${link.text}</span>
                    </a>
                `).join('');

                navbarUserSection.innerHTML = `
                    <a href="/login.html"
                       class="px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-all shadow-sm hover:shadow-md flex items-center gap-2">
                        <i data-lucide="log-in" class="w-4 h-4"></i>
                        <span>–í–æ–π—Ç–∏</span>
                    </a>
                `;
            }
        }

        window.navbarLogout = function() {
            console.log('üëã Logging out from navbar...');
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                localStorage.clear();
                window.location.href = '/login.html';
            }
        };

        initNavbarIcons();
        console.log('‚úÖ Navbar loaded successfully!');
    })();
</script>
